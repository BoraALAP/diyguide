{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 95, "column": 0}, "map": {"version":3,"sources":["file:///Users/artticfox/Desktop/Work/reactNative/diyguide/backend/src/utils/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\";\nimport { cookies } from \"next/headers\";\n\nexport async function createClient() {\n  const cookieStore = await cookies();\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll();\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options)\n            );\n          } catch {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    },\n  );\n}\n"],"names":[],"mappings":";;;AAAA;AACA;AADA;;;AAGO,eAAe;IACpB,MAAM,cAAc,MAAM,CAAA,GAAA,iIAAA,CAAA,UAAO,AAAD;IAEhC,OAAO,CAAA,GAAA,2KAAA,CAAA,qBAAkB,AAAD,6PAGtB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ"}},
    {"offset": {"line": 122, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}},
    {"offset": {"line": 160, "column": 0}, "map": {"version":3,"sources":["file:///Users/artticfox/Desktop/Work/reactNative/diyguide/backend/src/app/api/generate-guide/route.ts"],"sourcesContent":["\"use server\";\n\nimport OpenAI from \"openai\";\n\nimport { zodResponseFormat } from \"openai/helpers/zod\";\nimport { z } from \"zod\";\nimport { NextResponse } from \"next/server\";\nimport type { NextRequest } from \"next/server\";\nimport { createClient } from \"@/utils/supabase/server\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n  organization: process.env.OPENAI_ORGANIZATION_ID,\n  project: process.env.OPENAI_PROJECT_ID,\n});\n\nconst StepSchema = z.object({\n  step: z.number(),\n  description: z.string(),\n  materials: z.array(z.string()),\n  tools: z.array(z.string()),\n});\n\nconst GuideSchema = z.object({\n  title: z.string(),\n  content: z.string(),\n  steps: z.array(StepSchema),\n  tools: z.array(z.string()),\n  materials: z.array(z.string()),\n  tags: z.array(z.string()),\n  tips: z.array(z.string()),\n});\n\nexport async function POST(req: NextRequest) {\n  console.log(\"generating guide\");\n\n  // Verify API key for endpoint security\n  const apiKey = req.headers.get(\"x-api-key\");\n\n  if (!apiKey || apiKey !== process.env.API_AUTH_KEY) {\n    return NextResponse.json({ message: \"Unauthorized\" }, { status: 401 });\n  }\n\n  const { query } = await req.json();\n\n  try {\n    const supabase = await createClient();\n\n    const { data: existingTags, error: fetchError } = await supabase\n      .from(\"tags\")\n      .select(\"id, name\");\n\n    if (fetchError) throw new Error(\"Error fetching existing tags\");\n\n    const existingTagMap = Object.fromEntries(\n      existingTags.map((tag) => [tag.name, tag.id]),\n    );\n\n    const aiResponse = await openai.beta.chat.completions.parse({\n      model: \"gpt-4o-2024-08-06\",\n      messages: [{\n        role: \"system\",\n        content:\n          `You are a specialist on writing a do it your self guides. You are given a topic and you need to write a detailed guide for it. You need to provide steps and tips. Include a list of materials and tools needed with their measurements for each step and for the whole guide. additionally, give tags for the guide, please avoid tags like diy and please put space between words. Include tags for the guide. Use existing tags where applicable: ${\n            Object.keys(existingTagMap).join(\", \")\n          }.`,\n      }, {\n        role: \"user\",\n        content: query,\n      }],\n      response_format: zodResponseFormat(GuideSchema, \"guide\"),\n      max_tokens: 2000,\n    });\n\n    const content = aiResponse.choices[0].message.parsed;\n\n    if (!content) throw new Error(\"No content\");\n    const newTags = content.tags.filter((tag) => !existingTagMap[tag]);\n\n    if (newTags.length > 0) {\n      const { data: insertedTags, error: insertError } = await supabase\n        .from(\"tags\")\n        .insert(newTags.map((name) => ({ name })))\n        .select(\"id, name\");\n\n      if (insertError) throw new Error(\"Error inserting new tags\");\n\n      // Add new tags to the existingTagMap\n      insertedTags.forEach((tag) => {\n        existingTagMap[tag.name] = tag.id;\n      });\n    }\n\n    const { data: guideData, error: guideError } = await supabase\n      .from(\"guides\")\n      .insert([{\n        title: content.title,\n        content: content.content,\n        steps: content.steps,\n        tools: content.tools,\n        materials: content.materials,\n        created_by: \"AI\",\n        tips: content.tips,\n      }])\n      .select(\"id, title, content, steps, tips\")\n      .single();\n\n    if (guideError) {\n      console.log(guideError);\n\n      throw new Error(\"Error inserting guide\");\n    }\n\n    const guideId = guideData.id;\n\n    // Step 5: Link tags to the guide in the `guide_tags` table\n    const guideTags = content.tags.map((tag) => ({\n      guide_id: guideId,\n      tag_id: existingTagMap[tag],\n    }));\n\n    console.log(guideTags);\n\n    const { error: linkError } = await supabase\n      .from(\"guide_tags\")\n      .insert(guideTags);\n\n    if (linkError) throw new Error(\"Error linking tags to guide\");\n\n    return NextResponse.json({ data: guideData, error: null });\n  } catch (error) {\n    console.error(\"Error:\", error);\n    return NextResponse.json(\n      { error: \"Internal Server Error\" },\n      { status: 500 },\n    );\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 288, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}}]
}